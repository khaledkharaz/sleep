<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sleep White Noise</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#4e54c8" />
    <!-- Add these lines for iOS support -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="Sleep White Noise" />
    <!-- <link rel="apple-touch-icon" href="icon-192.png" /> -->
    <!-- Rest of your head content... -->
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: #121212;
        color: #e0e0e0;
        margin: 0;
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }
      .container {
        width: 90%;
        max-width: 500px;
        padding: 20px;
        background-color: #1e1e1e;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
        color: #ffffff;
      }
      .control-panel {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .slider-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      label {
        font-size: 18px;
        margin-bottom: 5px;
      }
      .slider {
        width: 100%;
        height: 15px;
        -webkit-appearance: none;
        appearance: none;
        background: #2d2d2d;
        border-radius: 10px;
        outline: none;
      }
      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        background: #4e54c8;
        border-radius: 50%;
        cursor: pointer;
      }
      .slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        background: #4e54c8;
        border-radius: 50%;
        cursor: pointer;
      }
      .time-display {
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        margin: 20px 0;
      }
      .button {
        padding: 15px 0;
        border: none;
        border-radius: 50px;
        background: linear-gradient(135deg, #4e54c8, #8f94fb);
        color: white;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(78, 84, 200, 0.4);
      }
      .button:active {
        transform: translateY(0);
      }
      .status {
        margin-top: 20px;
        text-align: center;
        font-size: 16px;
      }
      .noise-options {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
      }
      .noise-option {
        padding: 10px 15px;
        background-color: #2d2d2d;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .noise-option.active {
        background-color: #4e54c8;
      }
      .noise-option:hover {
        background-color: #3d3d3d;
      }
      .timer-options {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-bottom: 15px;
      }
      .timer-preset {
        padding: 8px 12px;
        background-color: #2d2d2d;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .timer-preset:hover {
        background-color: #3d3d3d;
      }
      .timer-preset.active {
        background-color: #4e54c8;
      }
      .visualizer {
        height: 100px;
        width: 100%;
        margin: 20px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .bar {
        width: 4px;
        background-color: #4e54c8;
        border-radius: 2px;
        transition: height 0.2s ease;
      }
      .slider-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 5px;
        font-size: 12px;
        color: #aaaaaa;
      }
      .timer-infinity-toggle {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        margin-top: 5px;
      }
      .infinity-label {
        margin-right: 10px;
        font-size: 14px;
      }
      .toggle {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
      }
      .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #2d2d2d;
        transition: 0.4s;
        border-radius: 24px;
      }
      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
      }
      input:checked + .toggle-slider {
        background-color: #4e54c8;
      }
      input:checked + .toggle-slider:before {
        transform: translateX(26px);
      }

      .custom-timer-input {
        margin-bottom: 15px;
      }
      .custom-timer-input label {
        display: block;
        margin-bottom: 5px;
      }
      .timer-set-button {
        padding: 8px 12px;
        border: none;
        border-radius: 15px;
        background-color: #2d2d2d;
        color: #e0e0e0;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
      }
      .timer-set-button:hover {
        background-color: #3d3d3d;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Sleep White Noise</h1>

      <div class="noise-options">
        <div class="noise-option active" id="white">White Noise</div>
        <div class="noise-option" id="pink">Pink Noise</div>
        <div class="noise-option" id="brown">Brown Noise</div>
      </div>

      <div class="visualizer" id="visualizer">
        <!-- Bars will be dynamically generated -->
      </div>

      <div class="control-panel">
        <div class="slider-container">
          <label for="volume">Volume</label>
          <input
            type="range"
            min="0"
            max="1"
            step="0.01"
            value="0.5"
            class="slider"
            id="volume"
          />
        </div>

        <div class="time-display">
          <span id="timer-display">1 hr</span>
        </div>

        <div class="timer-options">
          <div class="timer-preset" data-time="10">10 min</div>
          <div class="timer-preset" data-time="20">20 min</div>
          <div class="timer-preset" data-time="30">30 min</div>
          <div class="timer-preset active" data-time="60">1 hr</div>
          <div class="timer-preset" data-time="120">2 hrs</div>
          <div class="timer-preset" data-time="-1">∞</div>
        </div>

        <div class="custom-timer-input">
          <label for="custom-duration">Custom Timer (minutes):</label>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input
              type="number"
              id="custom-duration"
              min="1"
              placeholder="Enter minutes"
              style="width: 80px; padding: 8px; border-radius: 5px; border: 1px solid #2d2d2d; background-color: #1e1e1e; color: #e0e0e0;"
            />
            <button class="timer-set-button" id="set-custom-timer">Set Timer</button>
          </div>
        </div>

        <button class="button" id="play-pause">START</button>

        <div class="status" id="status">Ready to play</div>
      </div>
    </div>

    <script>
      // Audio Context (no longer needed for noise generation here)
      let audioContext; // Keep for visualizer if you want to connect it
      let analyser;
      let isPlaying = false;
      let timerInterval; // No longer used for timer logic
      let remainingTime = -1; // -1 means infinity
      let currentNoiseType = "white"; // Keep track of current noise type in UI
      let visualizerBars = [];

      // Initialize visualizer (remains the same)
      function initVisualizer() {
        const visualizer = document.getElementById("visualizer");
        visualizer.innerHTML = "";

        const barCount = 30;
        for (let i = 0; i < barCount; i++) {
          const bar = document.createElement("div");
          bar.className = "bar";
          bar.style.height = "3px";
          visualizer.appendChild(bar);
          visualizerBars.push(bar);
        }
      }

      // Update visualizer (remains the same, but audio source might change)
      function updateVisualizer() {
        if (!analyser || !isPlaying) return;
        // ... (same visualizer code as before) ...
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);

        // Calculate the average values for each bar
        const binSize = Math.floor(dataArray.length / visualizerBars.length);

        for (let i = 0; i < visualizerBars.length; i++) {
          const start = i * binSize;
          let sum = 0;
          for (let j = 0; j < binSize; j++) {
            sum += dataArray[start + j];
          }
          const average = sum / binSize;
          const height = Math.max(3, (average / 255) * 80);
          visualizerBars[i].style.height = `${height}px`;
        }

        requestAnimationFrame(updateVisualizer);
      }

      // Initialize audio context (only for visualizer now)
      function initAudio() {
        try {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 2048;

          // No need to create gainNode or noiseNode here

          return true;
        } catch (e) {
          console.error("Audio initialization failed:", e);
          document.getElementById("status").textContent =
            "Audio failed to initialize. Please try another browser.";
          return false;
        }
      }


      // Start or stop the noise (now communicates with service worker)
      function toggleNoise() {
        if (!isPlaying) {
          // Start playing
          const duration = remainingTime > 0 ? remainingTime : 0; // Send duration to SW
          navigator.serviceWorker.ready.then(registration => {
            registration.active.postMessage({
              action: 'start',
              noiseType: currentNoiseType,
              duration: duration // Send duration in minutes
            });
          });

          document.getElementById("play-pause").textContent = "STOP";
          document.getElementById("status").textContent = "Playing";
          isPlaying = true;

          // Start visualizer (if audio context initialized)
          if (audioContext) {
              // We need to get the analyser from the service worker's audio graph to visualize background audio.
              // This is more complex and might require more messaging or shared state.
              // For now, the visualizer might only work when the page is in the foreground.
              // A simpler approach for background visualization is to create a separate analyser in the service worker
              // and send visualization data back to the client, but that adds complexity.

              // For now, let's keep the visualizer as is, it will visualize when the page is in foreground.
              updateVisualizer();
          }


        } else {
          // Stop playing
          navigator.serviceWorker.ready.then(registration => {
            registration.active.postMessage({ action: 'stop' });
          });
          document.getElementById("play-pause").textContent = "START";
          document.getElementById("status").textContent = "Paused";
          isPlaying = false;
        }
      }

      // Update the timer display (remains the same UI logic)
      function updateTimerDisplay() {
        const display = document.getElementById("timer-display");

        if (remainingTime <= 0) {
          display.textContent = "∞";
          return;
        }

        const hours = Math.floor(remainingTime / 60);
        const minutes = remainingTime % 60;

        if (hours > 0) {
          display.textContent = `${hours}h ${minutes}m`;
        } else {
          display.textContent = `${minutes}m`;
        }
      }

      // Start the timer (no longer starts the interval here, just sets remainingTime and updates display)
      function startTimer(minutes) {
        remainingTime = minutes;
        updateTimerDisplay();
        if (isPlaying && minutes > 0) {
          navigator.serviceWorker.ready.then(registration => {
            registration.active.postMessage({ action: 'start', noiseType: currentNoiseType, duration: minutes }); // Restart timer in SW
          });
        } else if (isPlaying && minutes <= 0) {
          navigator.serviceWorker.ready.then(registration => {
            registration.active.postMessage({ action: 'clearTimer' }); // Clear timer in SW
          });
        }
      }

      // Set timer preset (updates UI and calls startTimer)
      function setTimerPreset(minutes) {
        remainingTime = minutes;
        updateTimerDisplay();

        // Update active class (same UI update)
        document.querySelectorAll(".timer-preset").forEach((preset) => {
          preset.classList.remove("active");
        });
        document
          .querySelector(`.timer-preset[data-time="${minutes}"]`)
          .classList.add("active");

        startTimer(minutes); // Call startTimer to update service worker if playing
      }

      // Initialize the app
      function init() {
        initVisualizer();
        initAudio(); // Initialize audio context (for visualizer)

        // Set up event listeners (mostly the same, but toggleNoise and timer logic changed)
        document
          .getElementById("play-pause")
          .addEventListener("click", toggleNoise);

        document
          .getElementById("volume")
          .addEventListener("input", function () {
            const volumeLevel = parseFloat(this.value);
            navigator.serviceWorker.ready.then(registration => {
              registration.active.postMessage({ action: 'setVolume', volume: volumeLevel });
            });
          });

        // Timer presets (same event listeners, but buttons are updated in HTML)
        document.querySelectorAll(".timer-preset").forEach((preset) => {
          preset.addEventListener("click", function () {
            setTimerPreset(parseInt(this.dataset.time));
          });
        });

        // New Event Listener for Custom Timer Button:
        document.getElementById('set-custom-timer').addEventListener('click', function() {
          const customMinutes = parseInt(document.getElementById('custom-duration').value, 10);
          if (isNaN(customMinutes) || customMinutes <= 0) {
            alert("Please enter a valid duration in minutes.");
            return;
          }
          setTimerPreset(customMinutes);
          // Clear active class from presets when custom timer is set
          document.querySelectorAll(".timer-preset").forEach((preset) => {
            preset.classList.remove("active");
          });
        });


        // Noise type options (now just updates currentNoiseType and sends message to SW on play)
        document.querySelectorAll(".noise-option").forEach((option) => {
          option.addEventListener("click", function () {
            currentNoiseType = this.id;
            navigator.serviceWorker.ready.then(registration => {
              registration.active.postMessage({ action: 'setNoiseType', noiseType: currentNoiseType });
            });
            document.querySelectorAll(".noise-option").forEach((opt) => opt.classList.remove('active'));
            option.classList.add('active');
          });
        });

        // Service Worker Registration (already present, keep it)
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker
            .register("sw.js")
            .then((registration) => {
              console.log("ServiceWorker registration successful");
            })
            .catch((err) => {
              console.log("ServiceWorker registration failed: ", err);
            });
        }

        // Wake Lock (keep it if you want to prevent screen sleep in foreground)
        if (navigator.wakeLock) {
          // ... (same wake lock logic) ...
        }

        // Service worker message listener - to receive timer ended event
        navigator.serviceWorker.addEventListener('message', event => {
          if (event.data.action === 'timerEnded') {
            console.log('Timer ended in Service Worker, stopping playback in UI.');
            if (isPlaying) {
              toggleNoise(); // Stop playback in UI as well
              alert('Timer ended! Playback stopped.'); // Or update UI to reflect timer end instead of alert
            }
          }
        });
      }

      // Call init on page load
      window.addEventListener("load", init);
    </script>
  </body>
</html>